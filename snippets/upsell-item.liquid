{%- assign color_label = 'color,colour,couleur,cor,colore,farbe,색,色,カラー,färg,farve,szín' | split: ',' -%}

<div class="product-item upsell-item {% if horizontal %}product-item--horizontal{% elsif list %}product-item--list{% else %}product-item--vertical{% endif %} {% if section.id == 'blog-sidebar' %}product-item--compact{% endif %} {{ grid_classes }}">
    {%- capture product_labels -%}
        {%- for tag in product.tags -%}
            {%- if tag contains '__label:' -%}
                <span class="product-label product-label--custom1">{{ tag | split: '__label:' | last }}</span>
            {%- endif -%}

            {%- if tag contains '__label1:' -%}
                <span class="product-label product-label--custom1">{{ tag | split: '__label1:' | last }}</span>
            {%- endif -%}

            {%- if tag contains '__label2:' -%}
                <span class="product-label product-label--custom2">{{ tag | split: '__label2:' | last }}</span>
            {%- endif -%}
        {%- endfor -%}

        {%- if settings.show_discount and settings.show_free_shipping == false and product.price < product.compare_at_price -%}
            {%- if settings.discount_mode == 'percentage' -%}
                {%- assign savings = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round | append: '%' -%}
            {%- else -%}
                {%- capture savings -%}
                    <span>{{ product.compare_at_price | minus: product.price | money }}</span>{%- endcapture -%}
            {%- endif -%}

            <span class="product-label product-label--on-sale">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
        {% elsif settings.show_free_shipping %}
            <span class="product-label product-label--on-sale">FRETE GRÁTIS</span>
        {%- endif -%}
    {%- endcapture -%}

    {%- if product_labels != blank -%}
        <div class="product-item__label-list">
            {{- product_labels -}}
        </div>
    {%- endif -%}

    {%- if settings.show_secondary_image and product.media.size > 1 -%}
        {%- assign show_secondary_media = true -%}
    {%- else -%}
        {%- assign show_secondary_media = false -%}
    {%- endif -%}

    {%- assign filtered_variant = '' -%}

    {%- if product.media.size > 0 -%}
        {%- assign primary_media = product.featured_media -%}

        {%- if request.page_type == 'collection' and section.settings.show_filters and section.settings.filter_type == 'group' -%}
            {%- assign matched_color_option = '' -%}

            {%- for tag in current_tags -%}
                {%- assign tag_parts = tag | split: '_' -%}
                {%- assign tag_group_name = tag_parts | first | downcase -%}
                {%- assign tag_group_value = tag_parts | last | downcase -%}

                {%- if color_label contains tag_group_name -%}
                    {%- comment -%}We have found a matching color label, then we check if this product contains an option named the same{%- endcomment -%}

                    {%- for option in product.options -%}
                        {%- assign downcased_option = option | downcase -%}

                        {%- if downcased_option == tag_group_name -%}
                            {%- comment -%}We have found the index of the matching option, so we can iterate through the variants{%- endcomment -%}
                            {%- assign option_index = 'option' | append: forloop.index -%}

                            {%- for variant in product.variants -%}
                                {%- assign variant_option_value = variant[option_index] | downcase -%}

                                {%- if variant_option_value == tag_group_value and variant.featured_media -%}
                                    {%- assign primary_media = variant.featured_media -%}
                                    {%- assign filtered_variant = variant -%}
                                    {%- break -%}
                                {%- endif %}
                            {%- endfor -%}

                            {%- break -%}
                        {%- endif -%}
                    {%- endfor -%}

                    {%- break -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}

        <a href="{{ filtered_variant.url | default: product.url | within: collection }}"
           class="product-item__image-wrapper {% if show_secondary_media %}product-item__image-wrapper--with-secondary{% endif %}">
            {%- capture supported_sizes -%}{%- render 'image-size', sizes: '200,300,400,500,600,700,800', image: primary_media.preview_image -%}{%- endcapture -%}
            {%- assign image_url = primary_media | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}

            <div class="aspect-ratio {% if settings.product_image_size != 'natural' %}aspect-ratio--{{ settings.product_image_size }}{% endif %}"
                 style="padding-bottom: {{ 100.0 | divided_by: primary_media.preview_image.aspect_ratio }}%">
                <img class="product-item__primary-image lazyload image--fade-in" data-media-id="{{ primary_media.id }}"
                     data-src="{{ image_url }}" data-sizes="auto" data-widths="[{{ supported_sizes }}]"
                     alt="{{ primary_media.alt | escape }}">

                {%- if show_secondary_media -%}
                    {%- capture supported_sizes -%}{%- render 'image-size', sizes: '200,300,400,500,600,700,800', image: product.media[1].preview_image -%}{%- endcapture -%}
                    {%- assign image_url = product.media[1] | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}

                    <img class="product-item__secondary-image lazyload image--fade-in" data-src="{{ image_url }}"
                         data-sizes="auto" data-widths="[{{ supported_sizes }}]"
                         alt="{{ product.media[1].alt | escape }}">
                {%- endif -%}

                <noscript>
                    <img src="{{ primary_image | img_url: '600x' }}" alt="{{ primary_media.alt | escape }}">
                </noscript>
            </div>
        </a>
    {%- endif -%}

    <div class="product-item__info">
        <div class="product-item__info-inner">
            {%- capture price_list -%}
                <div class="product-item__price-list price-list">
                    {%- if product.price < product.compare_at_price -%}
                        {%- if product.price_varies -%}
                            {%- capture price_min -%}<span>{{ product.price_min | money }}</span>{%- endcapture -%}
                            {%- capture price_max -%}<span>{{ product.price_max | money }}</span>{%- endcapture -%}
                            <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- product.variants[0].price | money -}}
              </span>

                            <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                {{- product.variants[0].compare_at_price | money -}}
              </span>
                        {%- else -%}
                            <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- product.variants[0].price | money -}}
              </span>

                            <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                {{- product.variants[0].compare_at_price | money -}}
              </span>
                        {%- endif -%}
                    {%- elsif product.price_varies -%}
                        {%- capture price_min -%}<span>{{ product.price_min | money }}</span>{%- endcapture -%}
                        {%- capture price_max -%}<span>{{ product.price_max | money }}</span>{%- endcapture -%}

                        <span class="price">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {{- product.variants[0].price | money -}}
            </span>
                    {%- else -%}
                        <span class="price">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {{- product.variants[0].price | money -}}
            </span>
                    {%- endif -%}

                    {% if settings.show_installments %}
                        {% assign taxa_decima_segunda_parcela = settings.taxa_decima_segunda_parcela | divided_by: 100 | plus: 1 %}

                        <p class="parcelamento" style='font-size:13px; margin-top: 0; margin-bottom: 10px'>em
                            12x {% if juros == 1 %} sem juros {% endif %} de <span style="color: black;"><b
                                        style="font-size:13px;">{{ product.variants[0].price | times: taxa_decima_segunda_parcela | divided_by: 12 | round: 2 | money }}</b></span>
                        </p>
                    {% endif %}

                    {% if settings.show_pix %}
                        <div class="parcelamento" style='font-size:13px; margin-top: 0px; margin-bottom: 10px'>
                            {% assign discount = product.variants[0].price | times: settings.desconto_pix | divided_by: 100 %}

                            Ou <b style="color: black;">{{ product.variants[0].price | minus: discount | money }}</b>
                            via Pix
                        </div>
                    {% endif %}
                </div>

                {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
                    <div class="product-item__price-info">
                        <div class="unit-price-measurement">
                            <span class="unit-price-measurement__price">{{ product.selected_or_first_available_variant.unit_price | money }}</span>
                            <span class="unit-price-measurement__separator">/ </span>

                            {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                                <span class="unit-price-measurement__reference-value">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                            {%- endif -%}

                            <span class="unit-price-measurement__reference-unit">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
                        </div>
                    </div>
                {%- endif -%}
            {%- endcapture -%}

            {%- capture vendor -%}
                {%- if settings.show_vendor -%}
                    {%- assign vendor_handle = product.vendor | handle -%}
                    {%- assign collection_for_vendor = collections[vendor_handle] -%}

                    {%- unless collection_for_vendor.empty? -%}
                        <a class="product-item__vendor link"
                           href="{{ collection_for_vendor.url }}">{{ product.vendor }}</a>
                    {%- else -%}
                        <a class="product-item__vendor link"
                           href="{{ product.vendor | url_for_vendor }}">{{ product.vendor }}</a>
                    {%- endunless -%}
                {%- endif -%}
            {%- endcapture -%}

            {%- if settings.product_price_position == 'before_title' -%}
                {{ price_list }}
            {%- endif -%}

            {%- if settings.product_price_position == 'after_title' -%}
                {{ vendor }}
            {%- endif -%}

            <a href="{{ filtered_variant.url | default: product.url | within: collection }}"
               class="product-item__title text--strong link">{{ product.title }}</a>

            {% if settings.product_text_bold %}
                <style>
                    .product-item__title {
                        font-weight: 500 !important;
                    }
                </style>
            {% endif %}

            {%- if settings.product_price_position == 'before_title' -%}
                {{ vendor }}
            {%- endif -%}

            {%- if settings.show_color_swatch and template != 'blog' -%}
                {%- capture color_swatch -%}
                    {%- capture color_name -%}{{ section.id }}-{{ product.id }}{%- endcapture -%}

                    {%- for option in product.options_with_values -%}
                        {%- assign downcased_option = option.name | downcase -%}

                        {%- if color_label contains downcased_option -%}
                            {%- assign variant_option = 'option' | append: forloop.index -%}
                            {%- assign value_to_match = filtered_variant[variant_option] | default: option.selected_value -%}

                            {%- for value in option.values -%}
                                {%- assign downcased_value = value | downcase -%}
                                {%- capture color_id -%}{{ color_name }}-{{ forloop.index }}{%- endcapture -%}

                                {%- for variant in product.variants -%}
                                    {%- if variant[variant_option] == value -%}
                                        {%- assign variant_for_value = variant -%}
                                        {%- break -%}
                                    {%- endif -%}
                                {%- endfor -%}

                                <div class="color-swatch {% if downcased_value == 'white' or downcased_value == 'blanc' %}color-swatch--white{% endif %}">
                                    {%- if variant_for_value.featured_media -%}
                                        {%- capture supported_sizes -%}{%- render 'image-size', sizes: '200,300,400,500,600,700,800', image: variant_for_value.featured_media.preview_image -%}{%- endcapture -%}
                                        {%- assign image_url = variant_for_value.featured_media | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
                                    {%- endif -%}

                                    {%- assign color_swatch_name = value | handle | append: '.png' -%}
                                    {%- assign color_swatch_image = images[color_swatch_name] -%}

                                    <input class="color-swatch__radio" type="radio" name="{{ color_name }}"
                                           id="{{ color_id }}" value="{{ value | escape }}"
                                           {% if value_to_match == value %}checked="checked"{% endif %}
                                           data-variant-url="{{ variant_for_value.url }}" {% if variant_for_value.featured_media %}data-media-id="{{ variant_for_value.featured_media.id }}" data-image-url="{{ image_url }}" data-image-widths="[{{ supported_sizes }}]" data-image-aspect-ratio="{{ variant_for_value.featured_media.preview_image.aspect_ratio }}"{% endif %}
                                           aria-label="{{ value | escape }}">
                                    <label class="color-swatch__item lazyload" for="{{ color_id }}"
                                           {% if color_swatch_image != blank %}data-bg="{{ color_swatch_image | img_url: '64x64' }}"
                                           {% else %}style="background-color: {{ value | replace: ' ', '' | downcase }}"{% endif %}
                                           title="{{ value | escape }}">
                                        <span class="visually-hidden">{{ value }}</span>
                                    </label>
                                    <a href="{{ product.url }}"
                                       class="color-swatch__item-link">+{{ option.values.size | minus: forloop.index0 }}</a>
                                </div>
                            {%- endfor -%}
                        {%- endif -%}
                    {%- endfor -%}
                {%- endcapture -%}

                {%- if color_swatch != blank -%}
                    <div class="product-item__swatch-list">
                        <div class="color-swatch-list">
                            {{ color_swatch }}
                        </div>
                    </div>
                {%- endif -%}
            {%- endif -%}

            {%- if settings.product_price_position == 'after_title' -%}
                {{ price_list }}
            {%- endif -%}
        </div>

        <div class="openDrawerHere">
            <button type="button"
                    {% if product.has_only_default_variant %}onclick="submitFunction('#product-select{{ product.id }}')"
                    {% else %}onclick="openPopup('.upsell{{ product.id }}')"{% endif %}>
                {% if product.has_only_default_variant %}{{ settings.addtocart }}{% else %}{{ settings.showOptions }}{% endif %}
            </button>
        </div>

    </div>

    {% if show_special_offer and settings.oferta_especial %}
        <div class="ofertas-destaque" onclick="window.location.href='{{ product.url }}'" style="order: 5;"><i
                    class="fas fa-star"></i><strong>Oferta Especial</strong></div>
    {% endif %}
</div>