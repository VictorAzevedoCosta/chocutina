<div data-section-id="{{ section.id }}" data-section-type="popups">
    {%- for block in section.blocks -%}
        {%- case block.type -%}
            {%- when 'newsletter' -%}
                {%- unless block.settings.show_only_on_index and template != 'index' -%}
                    {%- unless customer -%}
                        {% capture popup_settings %}
                            {
                            "apparitionDelay": {{ block.settings.apparition_delay | json }},
                            "showOnlyOnce": true
                            }
                        {% endcapture %}

                        <aside class="modal modal--newsletter" data-popup-type="newsletter"
                               data-popup-settings='{{ popup_settings }}'
                               aria-hidden="true" {{ block.shopify_attributes }}>

                            <div class="modal__dialog" role="dialog">
                                <div class="popup-newsletter">
                                    <button class="popup-newsletter__close link" data-action="close-popup"
                                            aria-label="{{ 'general.accessibility.close' | t }}">
                                        {%- render 'icon', icon: 'close' -%}
                                    </button>

                                    {%- form 'customer', id: 'newsletter-popup', class: 'form popup-newsletter__form' -%}
                                        {%- if form.posted_successfully? -%}
                                            {% if block.settings.thank_image %}
                                                <img class="lazyload" width="100%" height="100%" loading="lazy"
                                                     src="{{ block.settings.thank_image | img_url: '1x1' }}"
                                                     data-src="{{ block.settings.thank_image | img_url: '398x239', crop: 'center' }}"
                                                     alt="{{ block.settings.thank_image.alt | escape }}"
                                                     style="margin-bottom: 20px; border-radius: 5px;">
                                            {% endif %}

                                            {%- if block.settings.thank_text != blank -%}
                                                <div class="popup-newsletter__content rte">
                                                    {{ block.settings.thank_text }}
                                                </div>
                                            {%- endif -%}

                                            {%- if block.settings.discount_coupon != blank -%}
                                                <div class="cupom">
                                                    <span id="texto-cupom">PRIMEIRACOMPRA</span>
                                                    <svg id="copiar-cupom" width="32" height="33" viewBox="0 0 32 33" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.60156 1.09961C1.94471 1.09961 0.601562 2.44275 0.601562 4.09961V22.4996C0.601562 24.1565 1.94471 25.4996 3.60156 25.4996H8V23.4996H3.60156C3.04928 23.4996 2.60156 23.0519 2.60156 22.4996V4.09961C2.60156 3.54732 3.04928 3.09961 3.60156 3.09961H18.8016C19.3538 3.09961 19.8016 3.54732 19.8016 4.09961V5.30078H21.8016V4.09961C21.8016 2.44276 20.4584 1.09961 18.8016 1.09961H3.60156Z" fill="currentColor"></path>
                                                        <rect x="11.1992" y="8.5" width="19.2" height="22.4" rx="2" stroke="currentColor" stroke-width="2"></rect>
                                                    </svg>
                                                </div>
                                            {%- endif -%}
                                        {%- else -%}
                                            {% if block.settings.image %}
                                                <img class="lazyload" width="100%" height="100%" loading="lazy"
                                                     src="{{ block.settings.image | img_url: '1x1' }}"
                                                     data-src="{{ block.settings.image | img_url: '398x239', crop: 'center' }}"
                                                     alt="{{ block.settings.image.alt | escape }}"
                                                     style="margin-bottom: 20px; border-radius: 5px;">
                                            {% endif %}

                                            {%- if block.settings.content != blank -%}
                                                <div class="popup-newsletter__content rte">
                                                    {{ block.settings.content }}
                                                </div>
                                            {%- endif -%}

                                            <input type="hidden" name="contact[tags]" value="newsletter">

                                            <div class="form__input-wrapper form__input-wrapper--labelled">
                                                <input id="newsletter-popup[email]" type="text"
                                                       class="form__field form__field--text" name="contact[email]"
                                                       autofocus>
                                                <label for="newsletter-popup[email]"
                                                       class="form__floating-label">{{ 'general.popup.email_placeholder' | t }}</label>
                                            </div>

                                            <button class="button button--primary button--full"
                                                    type="submit">{{ block.settings.button_text }}</button>
                                        {%- endif -%}
                                    {%- endform -%}
                                </div>
                            </div>
                        </aside>
                    {%- endunless -%}
                {%- endunless -%}

            {%- when 'exit' -%}
                {%- unless customer -%}
                    {% capture popup_settings %}
                        {
                        "showOnlyOnce": {{ block.settings.show_only_once | json }}
                        }
                    {% endcapture %}

                    <aside class="modal modal--exit-popup" data-popup-type="exit"
                           data-popup-settings='{{ popup_settings }}' aria-hidden="true" {{ block.shopify_attributes }}>
                        <div class="modal__dialog" role="dialog">
                            <div class="exit-popup">
                                {%- if block.settings.title != blank -%}
                                    <h3 class="exit-popup__title heading">{{ block.settings.title | escape }}</h3>
                                {%- endif -%}

                                {%- if block.settings.subheading != blank -%}
                                    <p class="exit-popup__subheading heading">{{ block.settings.subheading | escape }}</p>
                                {%- endif -%}

                                <button class="exit-popup__close link" data-action="close-popup"
                                        aria-label="{{ 'general.accessibility.close' | t }}">
                                    {%- render 'icon', icon: 'close' -%}
                                </button>

                                {%- assign is_form_valid = false -%}

                                {%- if block.settings.show_newsletter -%}
                                    {%- form 'customer', id: 'exit-popup', class: 'form exit-popup__form' -%}
                                        {%- if form.posted_successfully? -%}
                                            {%- assign is_form_valid = true -%}
                                            <p class="alert alert--success alert--center">{{ block.settings.success_message }}</p>
                                        {%- else -%}
                                            <input type="hidden" name="contact[tags]" value="newsletter">

                                            <div class="form__input-wrapper form__input-wrapper--labelled">
                                                <input id="exit-popup[email]" type="text"
                                                       class="form__field form__field--large form__field--text"
                                                       name="contact[email]" autofocus>
                                                <label for="exit-popup[email]"
                                                       class="form__floating-label">{{ 'general.popup.email_placeholder' | t }}</label>
                                            </div>

                                            <button class="button button--primary button--extra-large button--full"
                                                    type="submit">{{ block.settings.button_text | escape }}</button>
                                        {%- endif -%}
                                    {%- endform -%}
                                {%- endif -%}

                                {%- if block.settings.close_message != blank and is_form_valid == false -%}
                                    <button class="exit-popup__pay-more link link--accented"
                                            data-action="close-popup">{{ block.settings.close_message }}</button>
                                {%- endif -%}
                            </div>
                        </div>
                    </aside>
                {%- endunless -%}
        {%- endcase -%}
    {%- endfor -%}
</div>

{% schema %}
{
  "name": "Popups",
  "max_blocks": 2,
  "blocks": [
    {
      "name": "Popup de Oferta",
      "type": "newsletter",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_only_on_index",
          "label": "Mostrar somente na página inicial",
          "default": false
        },
        {
          "type": "range",
          "id": "apparition_delay",
          "min": 0,
          "max": 15,
          "step": 1,
          "unit": "sec",
          "label": "Delay para exibição do popup",
          "default": 5
        },
        {
          "type": "header",
          "content": "Etapa inicial"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Imagem",
          "info": "398 x 239px .jpg recommended"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Descrição",
          "default": "<p>Cadastre-se e receba 5% off na sua primeira compra!</p>"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Texto do botão",
          "default": "PEGAR CUPOM"
        },
        {
          "type": "header",
          "content": "Etapa final"
        },
        {
          "type": "image_picker",
          "id": "thank_image",
          "label": "Imagem",
          "info": "398 x 239px .jpg recommended"
        },
        {
          "type": "richtext",
          "id": "thank_text",
          "label": "Descrição",
          "default": "<h4><strong>COPIE O CUPOM ABAIXO E USE ANTES DE FAZER SEU PEDIDO NO CHECKOUT!</strong></h4>"
        },
        {
          "type": "text",
          "id": "discount_coupon",
          "label": "Cupom de desconto",
          "default": "PRIMEIRACOMPRA"
        }
      ]
    },
    {
      "name": "Exit popup",
      "type": "exit",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Enable an exit popup if user attempts to navigate away from current page as a means of influencing user action on store."
        },
        {
          "type": "paragraph",
          "content": "Only visible on desktop."
        },
        {
          "type": "checkbox",
          "id": "show_only_for_visitors",
          "label": "Disable for account holders",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "show_only_once",
          "label": "Show once to visitors",
          "default": true
        },
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Get 15% off"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading",
          "default": "on your next order + exclusive offers"
        },
        {
          "type": "header",
          "content": "Newsletter"
        },
        {
          "type": "checkbox",
          "id": "show_newsletter",
          "label": "Show sign up form",
          "default": true
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text",
          "default": "Get my 15% off"
        },
        {
          "type": "text",
          "id": "success_message",
          "label": "Success message",
          "info": "Text displayed after the customer has entered their email.",
          "default": "You will receive soon an email containing your discount code!"
        },
        {
          "type": "text",
          "id": "close_message",
          "label": "Close message",
          "default": "No thanks, I'd rather pay more"
        }
      ]
    }
  ]
}
{% endschema %}